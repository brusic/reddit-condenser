<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Condenser</title>
    <style>
      :root {
        --reddit-blue: #0079d3;
        --reddit-dark: #1a1a1b;
        --reddit-light: #dae0e6;
        --reddit-gray: #a8a8a8;
        --reddit-border: #ccc;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #dae0e6;
        color: #1c1c1c;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background-color: white;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
      }

      input,
      select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background-color: var(--reddit-blue);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #0066b2;
      }

      .error {
        color: #ff4500;
        background-color: #ffebee;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #ff4500;
      }

      .post {
        background-color: white;
        border-radius: 4px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .post-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .post-score {
        background-color: #f6f7f8;
        border-radius: 2px;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: 700;
        color: #1c1c1c;
      }

      .post-info {
        flex: 1;
      }

      .post-subreddit {
        color: var(--reddit-blue);
        font-weight: 500;
        text-decoration: none;
      }

      .post-author {
        color: #696969;
        font-size: 12px;
      }

      .post-time {
        color: #696969;
        font-size: 12px;
      }

      .post-title {
        padding: 15px;
        font-size: 18px;
        font-weight: 500;
        color: #1c1c1c;
        text-decoration: none;
        display: block;
      }

      .post-title:hover {
        text-decoration: underline;
      }

      .post-content {
        padding: 0 15px 15px;
        color: #1c1c1c;
      }

      .post-footer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .comment-toggle,
      .post-link {
        color: #696969;
        text-decoration: none;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
      }

      .comment-toggle:hover,
      .post-link:hover {
        color: var(--reddit-blue);
        background-color: #f6f7f8;
      }

      .toggle-icon {
        font-size: 14px;
        margin-right: 5px;
        transition: transform 0.2s;
      }

      .toggle-icon.expanded {
        transform: rotate(90deg);
      }

      .comments-section {
        border-top: 1px solid #eee;
        padding: 15px;
      }

      .comments-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .comment {
        margin-bottom: 15px;
        border-left: 2px solid #e9e9e9;
        padding-left: 15px;
      }

      .comment-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
      }

      .comment-author {
        font-weight: 600;
        font-size: 13px;
      }

      .comment-score {
        background-color: #f6f7f8;
        border-radius: 2px;
        padding: 1px 4px;
        font-size: 11px;
        color: #1c1c1c;
      }

      .comment-time {
        color: #696969;
        font-size: 11px;
      }

      .comment-body {
        font-size: 14px;
        line-height: 1.4;
        color: #1c1c1c;
      }

      .nested-comments {
        margin-top: 10px;
        margin-left: 20px;
      }

      .markdown-content {
        white-space: pre-wrap;
        word-break: break-word;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #696969;
      }

      .collapsed {
        display: none;
      }

      .expand-icon {
        transition: transform 0.2s;
      }

      .expand-icon.rotated {
        transform: rotate(90deg);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Reddit Condenser</h1>
        <form id="searchForm" class="search-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="e.g., username" />
          </div>
          <div class="form-group">
            <label for="subreddit">Subreddit</label>
            <input type="text" id="subreddit" placeholder="e.g., javascript" />
          </div>
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" placeholder="e.g., react" />
          </div>
          <div class="form-group">
            <label for="limit">Limit</label>
            <select id="limit">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="form-group">
            <label for="time">Time</label>
            <select id="time">
              <option value="hour">Past Hour</option>
              <option value="day">Past Day</option>
              <option value="week">Past Week</option>
              <option value="month">Past Month</option>
              <option value="year">Past Year</option>
              <option value="all" selected>All Time</option>
            </select>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button type="submit">Search</button>
          </div>
        </form>
      </header>

      <main id="results">
        <div id="error" class="error" style="display: none"></div>
        <div id="loading" class="loading" style="display: none">Loading...</div>
        <div id="posts"></div>
      </main>
    </div>

    <script>
      class RedditCondenser {
        constructor() {
          this.posts = [];
          this.initializeForm();
          this.loadFromUrl();
        }

        initializeForm() {
          const form = document.getElementById("searchForm");
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            this.search();
          });

          // Update URL when form values change
          const inputs = form.querySelectorAll("input, select");
          inputs.forEach((input) => {
            input.addEventListener("change", () => {
              this.updateUrl();
            });
          });
        }

        loadFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);

          if (urlParams.has("username")) {
            document.getElementById("username").value =
              urlParams.get("username");
          }
          if (urlParams.has("subreddit")) {
            document.getElementById("subreddit").value =
              urlParams.get("subreddit");
          }
          if (urlParams.has("title")) {
            document.getElementById("title").value = urlParams.get("title");
          }
          if (urlParams.has("limit")) {
            document.getElementById("limit").value = urlParams.get("limit");
          }
          if (urlParams.has("time")) {
            document.getElementById("time").value = urlParams.get("time");
          }

          // If we have search parameters, perform initial search
          if (
            urlParams.has("username") ||
            urlParams.has("subreddit") ||
            urlParams.has("title")
          ) {
            this.search();
          }
        }

        updateUrl() {
          const username = document.getElementById("username").value;
          const subreddit = document.getElementById("subreddit").value;
          const title = document.getElementById("title").value;
          const limit = document.getElementById("limit").value;
          const time = document.getElementById("time").value;

          const params = new URLSearchParams();
          if (username) params.set("username", username);
          if (subreddit) params.set("subreddit", subreddit);
          if (title) params.set("title", title);
          if (limit) params.set("limit", limit);
          if (time) params.set("time", time);

          const newUrl = `${window.location.pathname}?${params.toString()}`;
          window.history.replaceState({}, "", newUrl);
        }

        showError(message) {
          const errorDiv = document.getElementById("error");
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
          document.getElementById("loading").style.display = "none";
        }

        hideError() {
          document.getElementById("error").style.display = "none";
        }

        showLoading() {
          document.getElementById("loading").style.display = "block";
          document.getElementById("posts").innerHTML = "";
          this.hideError();
        }

        hideLoading() {
          document.getElementById("loading").style.display = "none";
        }

        async search() {
          const username = document.getElementById("username").value.trim();
          const subreddit = document.getElementById("subreddit").value.trim();
          const title = document.getElementById("title").value.trim();
          const limit = document.getElementById("limit").value;
          const time = document.getElementById("time").value;

          // Validate that at least one filter is selected
          if (!username && !subreddit && !title) {
            this.showError(
              "Please select at least one filter (username, subreddit, or title)"
            );
            return;
          }

          this.showLoading();
          this.updateUrl();

          try {
            const query = this.buildQuery(username, subreddit, title);
            const url = `https://www.reddit.com/search.json?q=${encodeURIComponent(
              query
            )}&limit=${limit}&sort=new&t=${time}&raw_json=1`;

            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Reddit API error: ${response.status}`);
            }

            const data = await response.json();
            this.posts = data.data.children.filter(
              (post) => post.kind === "t3"
            );
            this.displayPosts();
          } catch (error) {
            console.error("Search error:", error);
            this.showError(`Error fetching posts: ${error.message}`);
          } finally {
            this.hideLoading();
          }
        }

        buildQuery(username, subreddit, title) {
          const parts = [];
          if (username) parts.push(`author:${username}`);
          if (subreddit) parts.push(`subreddit:${subreddit}`);
          if (title) parts.push(title);
          return parts.join(" ");
        }

        displayPosts() {
          const postsContainer = document.getElementById("posts");

          if (this.posts.length === 0) {
            postsContainer.innerHTML =
              "<p>No posts found matching your criteria.</p>";
            return;
          }

          postsContainer.innerHTML = this.posts
            .map((post) => this.createPostElement(post.data))
            .join("");

          // Add event listeners for comment toggles
          document.querySelectorAll(".comment-toggle").forEach((button) => {
            button.addEventListener("click", (e) => {
              const postId = e.target.closest(".post").dataset.postId;
              this.toggleComments(postId);
            });
          });
        }

        createPostElement(postData) {
          const timestamp = new Date(postData.created_utc * 1000);
          const timeAgo = this.timeAgo(timestamp);
          const commentCount = postData.num_comments || 0;
          const score = postData.score || 0;

          return `
                    <div class="post" data-post-id="${postData.id}">
                        <div class="post-header">
                            <div class="post-score">${score}</div>
                            <div class="post-info">
                                <a href="https://www.reddit.com/r/${
                                  postData.subreddit
                                }" class="post-subreddit" target="_blank">r/${
            postData.subreddit
          }</a>
                                <div class="post-author">Posted by u/${
                                  postData.author
                                }</div>
                                <div class="post-time">${timeAgo}</div>
                            </div>
                        </div>
                        <a href="https://www.reddit.com${
                          postData.permalink
                        }" class="post-title" target="_blank">${this.escapeHtml(
            postData.title
          )}</a>
                        ${
                          postData.selftext
                            ? `
                        <div class="post-content">
                            <div class="markdown-content">${this.renderMarkdown(
                              postData.selftext
                            )}</div>
                        </div>
                        `
                            : ""
                        }
                        <div class="post-footer">
                            <a href="https://www.reddit.com${
                              postData.permalink
                            }" class="post-link" target="_blank">
                                🌐 View on Reddit
                            </a>
                            <button class="comment-toggle" data-post-id="${
                              postData.id
                            }">
                                <span class="toggle-icon">▶</span>
                                💬 ${commentCount} ${
            commentCount === 1 ? "comment" : "comments"
          }
                            </button>
                        </div>
                        <div class="comments-section" id="comments-${
                          postData.id
                        }">
                            <div class="comments-header">
                                <span>${commentCount} ${
            commentCount === 1 ? "comment" : "comments"
          }</span>
                            </div>
                            <div class="comments-list" id="comments-list-${
                              postData.id
                            }">
                                <div class="loading-comments">Loading comments...</div>
                            </div>
                        </div>
                    </div>
                `;
        }

        async toggleComments(postId) {
          const commentsSection = document.getElementById(`comments-${postId}`);
          const commentsList = document.getElementById(
            `comments-list-${postId}`
          );
          const toggleButton = document.querySelector(
            `[data-post-id="${postId}"]`
          );
          const toggleIcon = toggleButton?.querySelector(".toggle-icon");

          if (commentsSection.classList.contains("collapsed")) {
            commentsSection.classList.remove("collapsed");
            if (toggleIcon) {
              toggleIcon.classList.add("expanded");
            }
            // Load comments if not already loaded
            if (commentsList.querySelector(".loading-comments")) {
              await this.loadComments(postId, commentsList);
            }
          } else {
            commentsSection.classList.add("collapsed");
            if (toggleIcon) {
              toggleIcon.classList.remove("expanded");
            }
          }
        }

        async loadComments(postId, commentsContainer) {
          try {
            // Show loading state
            commentsContainer.innerHTML =
              '<div class="loading-comments">Loading comments...</div>';

            // Add a small delay to make loading more apparent
            await new Promise((resolve) => setTimeout(resolve, 100));

            const url = `https://www.reddit.com/comments/${postId}.json?raw_json=1`;
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Failed to load comments: ${response.status}`);
            }

            const data = await response.json();
            const comments = data[1].data.children;
            commentsContainer.innerHTML = this.renderComments(comments);
          } catch (error) {
            console.error("Error loading comments:", error);
            commentsContainer.innerHTML = `<p>Error loading comments: ${error.message}</p>`;
          }
        }

        renderComments(comments, depth = 0) {
          if (!comments || comments.length === 0) {
            return "<p>No comments yet.</p>";
          }

          return comments
            .map((comment) => {
              if (comment.kind !== "t1" || !comment.data) return "";

              const commentData = comment.data;
              const timestamp = new Date(commentData.created_utc * 1000);
              const timeAgo = this.timeAgo(timestamp);
              const score = commentData.score || 0;

              let commentHtml = `
                        <div class="comment" data-comment-id="${
                          commentData.id
                        }">
                            <div class="comment-header">
                                <span class="comment-author">u/${this.escapeHtml(
                                  commentData.author || "[deleted]"
                                )}</span>
                                <span class="comment-score">${score} points</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-body">
                                <div class="markdown-content">${this.renderMarkdown(
                                  commentData.body || "[deleted]"
                                )}</div>
                            </div>
                    `;

              // Render nested comments if they exist
              if (
                commentData.replies &&
                commentData.replies.data &&
                commentData.replies.data.children
              ) {
                commentHtml += `
                            <div class="nested-comments">
                                ${this.renderComments(
                                  commentData.replies.data.children,
                                  depth + 1
                                )}
                            </div>
                        `;
              }

              commentHtml += "</div>";
              return commentHtml;
            })
            .join("");
        }

        renderMarkdown(text) {
          if (!text) return "";

          // Basic markdown rendering
          return text
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/~~(.*?)~~/g, "<del>$1</del>")
            .replace(/`(.*?)`/g, "<code>$1</code>")
            .replace(/\n/g, "<br>");
        }

        escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        timeAgo(date) {
          const now = new Date();
          const seconds = Math.floor((now - date) / 1000);

          let interval = Math.floor(seconds / 31536000);
          if (interval > 1) return `${interval} years ago`;
          if (interval === 1) return "1 year ago";

          interval = Math.floor(seconds / 2592000);
          if (interval > 1) return `${interval} months ago`;
          if (interval === 1) return "1 month ago";

          interval = Math.floor(seconds / 86400);
          if (interval > 1) return `${interval} days ago`;
          if (interval === 1) return "1 day ago";

          interval = Math.floor(seconds / 3600);
          if (interval > 1) return `${interval} hours ago`;
          if (interval === 1) return "1 hour ago";

          interval = Math.floor(seconds / 60);
          if (interval > 1) return `${interval} minutes ago`;
          if (interval === 1) return "1 minute ago";

          return "just now";
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new RedditCondenser();
      });
    </script>
  </body>
</html>
